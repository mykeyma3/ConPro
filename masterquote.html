<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Take Off Builder – Millwork Edition</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X05KTH78HS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-X05KTH78HS');
</script>
  
  <!-- SheetJS for Excel handling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <!-- Updated Light-Theme Styles -->
  <style>
    /* Color palette (light, high-contrast) */
    :root {
      --primary: #1e90ff;         /* Dodger blue */
      --primary-hover: #1c86ee;   /* Darker on hover */
      --bg-start: #f5f7fa;        /* Very light gray-blue */
      --bg-end: #e4ebf1;          /* Slightly darker */
      --surface: #ffffff;         /* Pure white surfaces */
      --text: #333333;            /* Dark charcoal text */
      --muted: #777777;           /* Mid gray for secondary text */
      --border: #d1d5db;          /* Soft gray border */
      --header-bg: #1e3a8a;       /* Deep indigo for table headers */
      --header-text: #ffffff;     /* White header text */
      --row-alt: #fafbfc;         /* Subtle striped rows */
      --status-success: #28a745;  /* Bootstrap-green */
      --status-error:   #dc3545;  /* Bootstrap-red */
      --status-info:    #0d6efd;  /* Bootstrap-blue */
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header, main, footer {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    header h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--primary);
    }
    header p {
      margin: 0.5rem 0 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    #instructions {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1.5rem;
    }
    #instructions h2 {
      margin-top: 0;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--primary);
    }
    #instructions ul {
      margin: 0.5rem 0 0 1rem;
      padding: 0;
      list-style-type: disc;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .controls label,
    .controls button {
      background: var(--primary);
      color: #fff;
      border: 1px solid var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .controls label:hover,
    .controls button:hover {
      background: var(--primary-hover);
    }
    .controls button[disabled] {
      background: var(--border);
      border-color: var(--border);
      cursor: not-allowed;
    }

    #status-log {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1rem;
      margin: 1.5rem auto 0;
      max-width: 800px;
      height: 140px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--text);
    }
    .status-success { color: var(--status-success); }
    .status-error   { color: var(--status-error);   }
    .status-info    { color: var(--status-info);    }

    #table-container {
      margin: 1.5rem auto;
      width: 100%;
      height: 50vh;
      overflow: auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 0.95rem;
    }
    th {
      background: var(--header-bg);
      color: var(--header-text);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: var(--row-alt);
    }

    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: auto;
      background: var(--surface);
    }
  </style>
</head>
<body>
  <header>
    <h1>Take Off Builder – Millwork Edition</h1>
    <p>Compatibility: Master Quote v6.25.25</p>
  </header>
  <main>
    <section id="instructions" aria-labelledby="instr-heading">
      <h2 id="instr-heading">How to Tag Your Items</h2>
      <p>In PlanSwift, append each item's name with one of the following tags:</p>
      <ul>
        <li>Door Units Call – <strong>UDU</strong></li>
        <li>Unit Hardware Call – <strong>UDH</strong></li>
        <li>Bath Hardware – <strong>UBH</strong></li>
        <li>Shower Door – <strong>TSD</strong></li>
        <li>Mirrors – <strong>TUM</strong></li>
        <li>Millwork – <strong>TUT</strong></li>
        <li>Shelving – <strong>TUS</strong></li>
        <li>Window Blinds – <strong>UWB</strong></li>
      </ul>
      <p><em>Example:</em> <code>R-01 4A - UDU</code></p>
    </section>

    <div class="controls">
      <label for="file-input">Upload .xlsx</label>
      <input type="file" id="file-input" accept=".xlsx" hidden />
      <button id="export-btn" disabled>Download Export</button>
    </div>

    <div id="status-log" aria-live="polite"></div>
    <div id="table-container"></div>
  </main>

  <div id="overlay"><div class="spinner"></div></div>

  <footer>
    &copy; <span id="year"></span> Michael Marrazzo. All rights reserved.
  </footer>

  <script>
    // Auto-update year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Configuration
    const categoryOrder = ['UDU','UDH','UBH','TSD','TUM','TUT','TUS','UWB'];
    const categoryLabel = { UDU:'Door',UDH:'DH',UBH:'BH',TSD:'SD',TUM:'Mir',TUT:'Trim',TUS:'Wire',UWB:'Blinds' };
    const itemOrder = {
      UBH:['TP','18" TB','24" TB','Robe Hook','Towel Ring','5\' Straight Rod','5\' Curved Rod','Other Rod','12gb','18gb','24gb','32gb','36gb','42gb','Seat','Mirr. MedCab','Rec. MedCab'],
      UDH:['Ent','Pat','Sto','Gar','Pri','Pass','Dummy','Mech','Pkt Pri','Pkt Pass','Byp Cup','Barn','HS/WS','Floor Stop','Half Dome Stop'],
      TUT:['Base Only','Base + Shoe','Crown','Hand rail','Stair Skirt','Stair Riser','Stair Tread','Half Wall','Lattice @ C\'top','3\' Open Linen','4\' Open Linen','5\' Open Linen','Wdw Stool']
    };
    let rawData = [], pages = [], items = [], matrix = {};
    let pageKey, itemKey, countKey;

    const fileInput = document.getElementById('file-input');
    const exportBtn = document.getElementById('export-btn');
    const tableContainer = document.getElementById('table-container');
    const overlay = document.getElementById('overlay');
    const statusLog = document.getElementById('status-log');

    function log(message, type='info') {
      const div = document.createElement('div');
      div.textContent = message;
      div.className = `status-item status-${type}`;
      statusLog.appendChild(div);
      statusLog.scrollTop = statusLog.scrollHeight;
    }
    function clearLog() { statusLog.innerHTML = ''; }
    function toggleOverlay(show) { overlay.style.display = show ? 'flex' : 'none'; }
    function revealTable() {
      tableContainer.style.opacity = '1';
      tableContainer.style.pointerEvents = 'auto';
      exportBtn.disabled = false;
    }

    document.querySelector('label[for="file-input"]').onclick = () => fileInput.click();
    fileInput.addEventListener('change', handleFile);
    exportBtn.addEventListener('click', exportExcel);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      clearLog(); toggleOverlay(true);
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = evt.target.result;
          const wb = XLSX.read(data, { type: 'binary' });
          rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });

          const steps = [
            { msg: 'Detecting columns...', fn: detectKeys },
            { msg: 'Building data matrix...', fn: buildMatrix },
            { msg: 'Rendering table...', fn: displayTable },
            { msg: 'Finalizing...', fn: () => {
                log(pages.length ? 'Ready to export.' : 'No data found.', pages.length ? 'success' : 'error');
                if (pages.length) revealTable();
                toggleOverlay(false);
                fileInput.value = '';
              }
            }
          ];

          let idx = 0;
          function nextStep() {
            if (idx >= steps.length) return;
            const step = steps[idx++];
            log(step.msg, 'info');
            step.fn();
            setTimeout(nextStep, 800);
          }
          nextStep();
        } catch (err) {
          log('Error processing file: ' + err.message, 'error');
          toggleOverlay(false);
          fileInput.value = '';
        }
      };
      reader.readAsBinaryString(file);
    }

    function detectKeys() {
      const keys = Object.keys(rawData[0] || {});
      pageKey  = keys.find(k => /page$/i.test(k) || /^unit$/i.test(k));
      itemKey  = keys.find(k => /digitizer\s*item/i.test(k) || /^item$/i.test(k));
      countKey = keys.find(k => /total/i.test(k) || /count/i.test(k));
      if (!pageKey || !itemKey || !countKey) throw new Error('Missing required columns');
    }

    function buildMatrix() {
      pages = [];
      const agg = {};
      rawData.forEach((r, i) => {
        const p = r[pageKey], itm = r[itemKey];
        let ct = parseFloat(r[countKey]); if (isNaN(ct)) { ct = 0; log(`Row ${i+2}: non-numeric count; defaulting to 0`, 'error'); }
        if (!p || !itm) return;
        if (!pages.includes(p)) pages.push(p);
        const m = String(itm).match(/-\s*(UDU|UDH|UBH|TSD|TUM|TUT|TUS|UWB)\s*$/);
        const cat = m ? m[1] : 'UNKNOWN';
        if (cat === 'UNKNOWN') log(`Item "${itm}" missing tag`, 'error');
        const prefix = String(itm).replace(/-\s*(UDU|UDH|UBH|TSD|TUM|TUT|TUS|UWB)\s*$/, '').trim();
        const key = `${cat}|${prefix}`;
        agg[key] = agg[key] || {};
        agg[key][p] = (agg[key][p] || 0) + ct;
      });
      pages.sort((a,b) => a.localeCompare(b, undefined, { numeric: true }));
      items = [];
      matrix = {};
      categoryOrder.forEach(cat => {
        const fixed = itemOrder[cat] || [];
        const dyn = Object.keys(agg).filter(k => k.startsWith(cat + '|')).map(k => k.split('|')[1]);
        const dynUnique = [...new Set(dyn)].filter(n => !fixed.includes(n));
        fixed.forEach(name => items.push({ cat, name }));
        dynUnique.sort((a,b) => a.localeCompare(b, undefined, { numeric: true })).forEach(name => items.push({ cat, name }));
      });
      items.forEach(({ cat, name }) => {
        matrix[name] = {};
        const key = `${cat}|${name}`;
        pages.forEach(p => matrix[name][p] = agg[key]?.[p] || 0);
      });
      pages = pages.filter(p => items.some(({ name }) => matrix[name][p] !== 0));
    }

    function displayTable() {
      tableContainer.innerHTML = '';
      if (!pages.length) { tableContainer.textContent = 'No pages with data.'; return; }
      const tbl = document.createElement('table');
      const thead = tbl.createTHead();
      const headerRow = thead.insertRow();
      ['Category','Item', ...pages].forEach(text => {
        const th = document.createElement('th'); th.textContent = text; headerRow.appendChild(th);
      });
      const tbody = tbl.createTBody();
      items.forEach(({ cat, name }, idx) => {
        const tr = tbody.insertRow();
        const cc = tr.insertCell();
        cc.textContent = (idx === 0 || items[idx-1].cat !== cat) ? categoryLabel[cat] || '' : '';
        tr.insertCell().textContent = name;
        pages.forEach(p => tr.insertCell().textContent = matrix[name][p]);
      });
      tableContainer.appendChild(tbl);
    }

    function exportExcel() {
      log('Preparing export...', 'info');
      const wb = XLSX.utils.book_new();
      pages.sort((a,b) => a.localeCompare(b, undefined, { numeric:true }));
      categoryOrder.forEach(cat => {
        const label = categoryLabel[cat];
        const sheetItems = items.filter(i => i.cat === cat);
        if (!sheetItems.length) return;
        const aoa = [["Category","Item", ...pages]];
        sheetItems.forEach(({ name }, i) => aoa.push([(i===0 ? label : ''), name, ...pages.map(p => matrix[name][p]) ]));
        aoa.push([]);
        aoa.push([`created by Michael Marrazzo 2025`]);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        ws['!cols'] = [{ wch:10 },{ wch:30 }, ...pages.map(_ => ({ wch:8 }))];
        XLSX.utils.book_append_sheet(wb, ws, label);
      });
      XLSX.writeFile(wb, 'transformed_export.xlsx');
      log('Export complete!', 'success');
    }
  </script>
</body>
</html>
